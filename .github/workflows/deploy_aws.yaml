name: Deploy on AWS

on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest

  services:
      localstack:
        runs-on: ubuntu-latest
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: ec2,s3,dynamodb
  steps:
  
  - name: Show localstack logs
    run: |
      localstack logs | tee localstack.log

  - name: Checkout repo
    uses: actions/checkout@v3

  - name: Set up Terraform
    uses: hashicorp/setup-terraform@v2
    with:
      terraform_version: 1.5.7

  - name: Terraform Init
    run: terraform init

  - name: Terraform Plan
    run: terraform plan
  
  - name: Terraform Apply
    run: terraform apply -auto-approve